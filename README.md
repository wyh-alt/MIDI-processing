# 🎵 MIDI处理整合工具

[![Python](https://img.shields.io/badge/python-3.6%2B-blue.svg)](https://python.org)
[![PyQt5](https://img.shields.io/badge/GUI-PyQt5-green.svg)](https://pypi.org/project/PyQt5/)
[![MIDI](https://img.shields.io/badge/format-MIDI-orange.svg)](https://midi.org)

一个功能强大的MIDI文件处理工具，集成了MIDI速度转换、音符重叠检测与修复、批量处理等功能。专为音乐制作人、编曲师和MIDI文件编辑者设计，提供专业级的MIDI文件处理能力。

## ✨ 核心特性

### 🎛️ MIDI速度转换
- **精确BPM转换** - 将MIDI文件转换为指定BPM（1.0-999.99），支持高精度小数设置
- **时间线性伸缩** - 参考Cubase时间线性模式，保持原始时间位置进行精确伸缩
- **变速MIDI支持** - 自动识别和处理包含多个速度变化的复杂MIDI文件
- **智能跳过匹配** - 可选择跳过已匹配目标BPM的文件，避免重复处理
- **保持原始速度选项** - 可选择保持原始MIDI速度，不进行BPM转换

### 🔍 音符重叠检测与处理
- **智能重叠检测** - 精确检测单轨道和多轨道MIDI文件中的音符重叠
- **分层处理策略** - 区分轨道内重叠（需要修复）和跨轨道重叠（正常编曲）
- **多种处理模式**：
  - **分轨道模式（默认）** - 仅处理各轨道内部的重叠，保护和弦等正常编曲
  - **跨轨道全局模式** - 处理所有重叠，包括跨轨道重叠（谨慎使用）
- **高级算法** - 同音符重叠FIFO配对处理，前后重叠音符裁剪优化
- **独立处理机制** - 重叠处理不受"跳过匹配文件"选项影响，确保始终执行

### 🎚️ 音频参数控制
- **统一音符力度** - 将所有音符力度设置为指定百分比（1-100%）
- **控制消息清理** - 可选择移除CC控制信息、弯音、程序变更、踏板等
- **精确力度控制** - 支持1-127范围内的精确MIDI力度设置
- **保持音符完整性** - 处理过程中维护音符的精确时间位置和持续时间

### 📁 批量处理能力
- **目录批量处理** - 支持整个文件夹的批量MIDI文件处理
- **混合文件处理** - 支持单个文件和目录的混合批量处理
- **拖放操作** - 直观的文件和文件夹拖放功能，支持多文件选择
- **进度追踪** - 实时显示处理进度和详细结果
- **文件格式支持** - 支持.mid和.midi格式文件

### 📊 结果分析与导出
- **详细结果显示** - 表格形式展示每个文件的处理状态和重叠信息
- **状态颜色编码** - 重叠文件用红色字体高亮显示，便于快速识别
- **Excel导出功能** - 支持将处理结果导出为Excel文件，便于进一步分析
- **智能状态管理** - 显示"成功"、"已处理"、"仅检测"、"无需处理"等详细状态
- **实时日志显示** - 提供详细的处理日志，方便问题诊断

## 🏗️ 技术架构

### 核心模块
```
MIDI处理整合/
├── MIDI速度转换/          # 主要处理模块
│   ├── main.py            # 程序入口
│   ├── ui.py              # PyQt5图形界面
│   ├── midi_processor.py  # 核心MIDI处理引擎
│   └── requirements.txt   # 依赖列表
└── MIDI-Overlap-Check/    # 重叠检测模块
    ├── midicheck.py       # 独立重叠检测工具
    └── setup.py           # 打包配置
```

### 技术栈
- **界面框架**: PyQt5 - 现代化的跨平台GUI框架
- **MIDI处理**: python-mido - 高性能MIDI文件读写库
- **实时音频**: python-rtmidi - MIDI实时传输支持
- **数据处理**: Python 3.6+ - 高精度时间计算和算法优化
- **数据导出**: pandas - Excel文件导出支持（可选）
- **打包工具**: PyInstaller - 生成独立可执行文件

## 🚀 快速开始

### 系统要求
- Python 3.6 或更高版本
- Windows 7/10/11 或 macOS 10.12+ 或 Linux

### 安装依赖
```bash
# 克隆项目
git clone https://github.com/your-username/MIDI处理整合.git
cd MIDI处理整合/MIDI速度转换

# 安装依赖
pip install -r requirements.txt
```

### 主要依赖
```
PyQt5>=5.15.0
mido>=1.2.10
python-rtmidi>=1.4.9
pandas>=1.0.0  # 可选，用于Excel导出功能
```

### 运行程序
```bash
# 启动主程序
python main.py
```

## 📖 使用指南

### 基础操作流程

1. **选择输入文件**
   - 拖放MIDI文件或文件夹到程序界面
   - 或点击"浏览..."按钮选择输入目录

2. **配置处理选项**
   - **目标BPM**: 设置转换的目标速度（默认120）
   - **统一音符力度**: 设置音符力度百分比（1-100%）
   - **移除控制消息**: 清理CC控制信息和弯音数据
   - **跳过匹配文件**: 跳过已匹配目标BPM的文件

3. **重叠检测配置**
   - **检测音符重叠**: 启用音符重叠分析
   - **重叠音符处理**: 自动修复检测到的重叠
   - **跨轨道重叠处理**: 处理多轨道间的重叠（谨慎使用）

4. **执行处理**
   - 点击"开始处理"按钮
   - 查看实时进度和处理结果
   - 结果自动保存到指定输出目录

### 高级功能

#### 智能跳过匹配文件
当启用"跳过匹配文件"时：
- ✅ 自动跳过BPM已匹配的文件，避免重复处理
- ✅ 重叠检测和处理功能独立运行，不受跳过影响
- ✅ 显示"仅检测"状态，提供重叠信息但不输出文件

#### 多轨道重叠处理策略
```
分轨道模式（默认）:
├── 轨道1: 钢琴主旋律    ✓ 处理轨道内重叠
├── 轨道2: 和弦伴奏      ✓ 处理轨道内重叠
└── 跨轨道重叠           ✗ 视为正常编曲

全局模式（可选）:
└── 所有重叠             ✓ 全部处理
```

#### 重叠处理算法
1. **同音符重叠**: 前一个音符被裁剪，后一个音符保持完整
2. **不同音符重叠**: 按时间优先级处理，避免音符冲突
3. **质量控制**: 自动删除持续时间小于1ms的无效音符

## 📋 处理结果说明

### 状态含义
| 状态 | 含义 | 说明 |
|------|------|------|
| **成功** | 文件已成功处理 | 创建了新的输出文件 |
| **已处理（重叠）** | 仅处理了重叠音符 | 文件BPM匹配但处理了重叠 |
| **已处理（强制）** | 强制处理模式 | 关闭跳过匹配时的强制输出 |
| **仅检测** | 仅执行重叠检测 | 检测重叠但未处理，无输出文件 |
| **无需处理** | 文件已符合要求 | 跳过处理，无输出文件 |
| **处理失败** | 处理过程出错 | 显示错误信息 |

### 重叠状态指示
- 🔴 **红色字体**: 存在重叠的文件（包括轨道内重叠、跨轨道重叠等）
- ⚪ **普通字体**: 无重叠的文件
- **重叠类型**:
  - `存在重叠 (X 处)` - 单轨道重叠
  - `轨道内重叠 (X 处)` - 多轨道文件的轨道内重叠
  - `多轨全局重叠 (X 处)` - 全局模式检测的重叠
  - `跨轨道重叠 (X 处, 正常)` - 跨轨道重叠（通常是正常编曲）

## ⚙️ 配置选项详解

### 速度转换选项
- **MIDI速度转换**: 启用/禁用BPM转换功能（勾选时执行速度转换）
- **目标BPM**: 转换的目标速度值（1.0-999.99 BPM），支持小数设置
- **保持原始节拍**: 保持原始时间位置的精确性

### 音频处理选项  
- **统一音符力度**: 将所有音符设置为统一力度值
- **力度百分比**: 音符力度的百分比值（1-100%），自动转换为MIDI力度值（1-127）
- **移除控制消息**: 清理MIDI控制信息（CC、弯音、程序变更、踏板等）

### 文件处理选项
- **跳过匹配文件**: 自动跳过已符合条件的文件（BPM匹配且无需处理）
- **检测音符重叠**: 启用音符重叠分析功能
- **重叠音符处理**: 自动修复检测到的重叠问题（需先启用检测）
- **跨轨道重叠处理**: 处理多轨道间的音符重叠（需同时启用检测和处理）

## 🔧 故障排除

### 常见问题

**Q: 程序启动时提示缺少依赖**
```bash
# 重新安装依赖
pip install --upgrade -r requirements.txt
```

**Q: 处理大文件时程序无响应**
- 这是正常现象，程序正在处理中
- 可以查看控制台输出了解详细进度
- 建议分批处理大量文件

**Q: 重叠检测结果不准确**
- 确保MIDI文件格式正确（支持.mid和.midi）
- 检查MIDI文件是否包含有效的音符数据
- 尝试使用单轨道模式进行测试

**Q: 输出文件播放异常**
- 检查原始MIDI文件是否正常
- 确认目标BPM设置合理（推荐60-200范围）
- 验证音符力度设置是否适当

### 错误代码参考
- **文件读取错误**: 检查文件路径和权限
- **内存不足**: 减少批处理文件数量
- **格式不支持**: 确认文件为标准MIDI格式

## 🎯 最佳实践

### 处理前准备
1. **备份原始文件** - 处理前务必备份重要的MIDI文件
2. **检查文件质量** - 确保输入文件没有损坏
3. **合理设置参数** - 根据音乐风格调整BPM和力度

### 批量处理建议
1. **分批处理** - 建议每次处理50-100个文件
2. **结果验证** - 处理后随机检查几个文件确保质量
3. **目录规划** - 使用清晰的目录结构组织输入和输出文件

### 重叠处理策略
1. **先检测后处理** - 首先运行重叠检测，了解问题范围
2. **谨慎使用跨轨道处理** - 仅在确实需要时启用全局模式
3. **检查处理结果** - 重叠处理后验证音乐的完整性

## 🔄 更新日志

### v2.1.0 (Latest)
- ✨ 完善跨轨道重叠处理独立性，不受跳过匹配文件影响
- 🔧 修复多轨重叠显示颜色与单轨不一致的问题
- 📊 增强结果显示，支持更多类型的重叠状态显示
- 🚀 优化文件输出逻辑，仅重叠检测时不输出文件
- 📝 重新编写README文档，提供更准确的功能说明

### v2.0.0
- ✨ 新增多轨道智能重叠检测和处理
- ✨ 实现跳过匹配文件时的独立重叠处理
- 🔧 优化音符配对算法，修复FIFO配对问题
- 🎨 改进UI界面，增加状态颜色编码
- 📊 增强结果显示，支持详细重叠信息

### v1.5.0
- ✨ 增加音符重叠检测功能
- 🔧 改进MIDI速度转换精度
- 🎨 优化用户界面体验

### v1.0.0
- 🎉 首次发布
- ✨ 基础MIDI速度转换功能
- 📁 批量处理支持

## 🤝 贡献指南

欢迎提交Issue和Pull Request！

### 开发环境设置
```
# 克隆项目
git clone https://github.com/your-username/MIDI处理整合.git
cd MIDI处理整合/MIDI速度转换

# 安装依赖
pip install -r requirements.txt

# 运行程序
python main.py
```

### 提交规范
- 使用清晰的commit message
- 保证代码质量和可读性
- 更新相关文档

## 📞 支持与反馈

- **问题报告**: [GitHub Issues](https://github.com/your-username/MIDI处理整合/issues)
- **功能建议**: [GitHub Discussions](https://github.com/your-username/MIDI处理整合/discussions)

## 🙏 致谢

感谢以下开源项目：
- [python-mido](https://github.com/mido/mido) - MIDI文件处理
- [PyQt5](https://www.riverbankcomputing.com/software/pyqt/) - 图形界面框架
- [python-rtmidi](https://github.com/patrickkidd/python-rtmidi) - MIDI实时传输
- [pandas](https://pandas.pydata.org/) - 数据处理与导出

---

<div align="center">

**[⬆ 回到顶部](#-midi处理整合工具)**

为音乐制作人和音频产业从业者打造 ❤️

</div>
